<% provide(:title, 'Log in') %>

<div class="mdl-card login-card mdl-shadow--6dp">
  <%= form_for(:session, url: login_path, html: {class: 'col s12', id: 'otp_form'}) do |f| %>
    <div class="mdl-card__title">
    </div>
      <div class="mdl-card__supporting-text">
        <div class="mdl-textfield mdl-js-textfield">
          <%= f.text_field :otp_code %>
          <%= f.label :otp, 'Short Login Code' %>
        </div>
      </div>
      <div class="mdl-card__actions mdl-card--border">
        <button class="mdl-button mdl-button--raised mdl-button--accent mdl-js-button mdl-js-ripple-effect">Log in</button>
      </div>
  <% end %>
</div>
<div class="resend-controls">
  <% if @user.phone.present? %>
    <%= form_tag(resend_code_to_phone_path, id: 'resend-phone-form', remote: true) do |f| %>
      <button  type="submit" class="resend_otp_to_phone mdl-button mdl-js-button mdl-button--colored">Send Login Code to Phone</button>
        <div class="mdl-spinner mdl-js-spinner"></div>
    <% end %>
  <% end %>

  <% if @user.email.present? and @user.email_confirmed? %>
      <script>
        function submitResendEmailCodeForm() {
          document.getElementById('resend-email-code-form').submit();
          $('#resend-email-code-form .mdl-spinner').addClass('is-active');
          $('#resend-email-code-form .resend_otp_to_email').attr('disabled', '');
        }
        function resendEmailCodeResponseHandler(e) {
          let response = e.detail.parseResponse();
          console.log(response);
          if (response.success) {
            $('.otp_msg').html('Login code resent to email address');
          } else {
            $('.otp_msg').html('Could not resend the login code to your email!');
          }
          $('#resend-email-code-form .mdl-spinner').removeClass('is-active');
          $('#resend-email-code-form .resend_otp_to_email').removeAttr('disabled');
          $('.otp_msg').hide().fadeIn();
        }
        window.addEventListener('WebComponentsReady', function() {
          document.getElementById('resend-email-code-form').addEventListener('iron-form-response', resendEmailCodeResponseHandler)
        });
      </script>
    <%= form_tag(resend_code_to_email_path, class: 'col s6', id: 'resend-email-code-form', is: 'iron-form', 'on-iron-form-response': 'resendEmailCodeResponseHandler') do |f| %>
        <button onclick="submitResendEmailCodeForm()" class="resend_otp_to_email mdl-button mdl-js-button mdl-button--colored">Send Login Code to Email</button>
          <div class="mdl-spinner mdl-js-spinner"></div>
    <% end %>
  <% end %>
</div>
<div class="row">
  <div id="resend_link">
      
  </div>
</div>