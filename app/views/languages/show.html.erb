
<% provide(:title, 'Language Overview: ' + @language.name) %>

<% editable = (logged_in_user.national? or Language.user_limited(logged_in_user).include?(@language)) %>

<%= '<script>console.log("page is editable");</script>'.html_safe if editable %>

<div id="edit-response"></div>
<div id="pending-edits" class="mdl-grid">
  <% @user_pending_edits.each do |edit| %>
    <div class="mdl-cell mdl-cell--4-col">
      <%= render edit %>
    </div>
  <% end %>
</div>

<div class="mdl-grid">
  <div class="mdl-cell mdl-cell--6-col mdl-cell--2-col-phone">
    <h1>Language Overview</h1>
    <%= link_to show_details_language_path(@language) do %>
        <i class="material-icons">pageview</i> More details
    <% end %>
  </div>
  <div class="mdl-cell mdl-cell--4-offset-desktop mdl-cell--2-col">
    <div class="language-name"><h2 id="language-name" class="<%= 'editable' if editable %>"><%= @language.name %><%= render 'shared/edit_icon' if editable %></h2></div>
    <div id="language-iso" class="iso-code <%= 'editable' if editable %>">[<%= @language.iso %>]<%= render 'shared/edit_icon' if editable %></div>
  </div>
</div>

<div class="mdl-grid language-dashboard">

  <!-- finish line markers -->
  <div class="finish-line-status mdl-cell mdl-cell--4-col">

    <h3>Finish Line Status</h3>
    <table class="finish-line-status mdl-data-table mdl-js-data-table">
      <thead>
        <tr>
          <th class="mdl-data-table__cell--non-numeric">Finish Line Marker</th>
          <th class="mdl-data-table__cell--non-numeric" colspan="2">Status</th>
        </tr>
      </thead>
      <tbody>
        <% FinishLineMarker.find_each do |marker| %>
          <% progress = FinishLineProgress.find_or_create_by(language: @language, finish_line_marker: marker) %>
          <tr class="<%= progress.complete? ? 'complete' : 'incomplete' %>">
            <td id="finish-line-marker-<%= marker.number %>-name">
              <%= marker.name %>
              <span for="finish-line-marker-<%= marker.number %>-name" class="mdl-tooltip"><%= marker.description %></span>
            </td>
            <td>
              <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-<%= marker.name %>">
                <input type="checkbox" id="switch-<%= marker.name %>" class="mdl-switch__input" <%= progress.complete? ? 'checked' : '' %>>
                <span class="mdl-switch__label"></span>
              </label>
            </td>
            <td><%= progress.status.humanize %></td>
          </tr>
        <% end %>
      </tbody>
    </table>

  </div>

  <div class="mdl-cell mdl-cell--4-col">
    <h3>More Language Details</h3>
    <ul class="mdl-list">
      <li class="language-names mdl-list__item">
        <%= link_to 'Alternate Names', show_details_language_path(@language, anchor: 'language-names'), class: 'mdl-list__item-primary-content' %>
        <%= link_to show_details_language_path(@language, anchor: 'language-names'), class: 'mdl-list__item-secondary-content mdl-chip' do %>
            <span class="mdl-chip__text"><%= @language.language_names.count %></span>
        <% end %>
      </li>
      <li class="language-outcome-progress mdl-list__item">
        <%= link_to 'Outcome Progress', show_details_language_path(@language, anchor: 'outcome-progress'), class: 'mdl-list__item-primary-content' %>
      </li>
      <li class="language-bible-translation mdl-list__item">
        <%= link_to 'Bible Translation', show_details_language_path(@language, anchor: 'bible-translation'), class: 'mdl-list__item-primary-content' %>
      </li>
      <li class="language-engaged-organisations mdl-list__item">
        <%= link_to 'Engaged Organisations', show_details_language_path(@language, anchor: 'engaged-organisations'), class: 'mdl-list__item-primary-content' %>
        <%= link_to show_details_language_path(@language, anchor: 'engaged-organisations'), class: 'mdl-list__item-secondary-content mdl-chip' do %>
            <span class="mdl-chip__text"><%= @language.engaged_organisations.count %></span>
        <% end %>
      </li>
      <li class="language-translating-organisations mdl-list__item">
        <%= link_to 'Translating Organisations', show_details_language_path(@language, anchor: 'translating-organisations'), class: 'mdl-list__item-primary-content' %>
        <%= link_to show_details_language_path(@language, anchor: 'translating-organisations'), class: 'mdl-list__item-secondary-content mdl-chip' do %>
            <span class="mdl-chip__text"><%= @language.translating_organisations.count %></span>
        <% end %>
      </li>
      <li class="language-literacy mdl-list__item">
        <%= link_to 'Literacy', show_details_language_path(@language, anchor: 'literacy'), class: 'mdl-list__item-primary-content' %>
      </li>
      <li class="language-mt-resources mdl-list__item">
        <%= link_to 'Mother Tongue Resources', show_details_language_path(@language, anchor: 'mt-resources'), class: 'mdl-list__item-primary-content' %>
        <%= link_to show_details_language_path(@language, anchor: 'mt-resources'), class: 'mdl-list__item-secondary-content mdl-chip' do %>
            <span class="mdl-chip__text"><%= @language.mt_resources.count %></span>
        <% end %>
      </li>
    </ul>
  </div>

  <!-- map -->
  <div class="mdl-cell mdl-cell--4-col">
    <% map = get_map(@language) %>
    <% if map %>
      <%= image_tag(map, alt: "Map for #{@language.name}", class: 'language-map mdl-shadow--2dp') %>
    <% end %>
  </div>

  <div class="mdl-cell mdl-cell--4-col">
    <% if @impact_report %>
      <div class="impact-story mdl-card mdl-shadow--2dp">
        <div class="mdl-card__title">
          <h2 class="mdl-card__title-text">Impact Story</h2>
        </div>
        <div class="mdl-card__supporting-text">
          <div><%= time_ago_in_words(@impact_report.report_date) %> ago</div>
          <%= simple_format @impact_report.content %>
          <% @impact_report.pictures.each do |picture| %>
              <%= image_tag picture.ref_url if picture.ref? %>
          <% end %>
          <%# Show the reporter name if the logged in user is trusted, or if it's them. %>
          <% if @impact_report.reporter and (logged_in_user.trusted? or logged_in_user?(report.reporter)) %>
              <div class="reporter"><%= @impact_report.reporter.name %></div>
          <% end %>
        </div>
        <div class="mdl-card__actions">
          <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
            More impact stories...
          </a>
        </div>
      </div>
    <% else %>
      <p>No impact reports.</p>
    <% end %>
  </div>
</div>

<%= render 'edit_dialogs' if editable %>

<script>
  $('dialog').each(function() {
    let dialog = this;
    if (! dialog.showModal) {
      dialogPolyfill.registerDialog(dialog);
    }
    $(dialog).find('.submit').on('click', function() {
      $(dialog).find('form').submit();
      dialog.close();
    });
    $(dialog).find('.cancel').on('click', function() {
      dialog.close();
    });
  });
  $( document ).ajaxSuccess(function( event, xhr, settings, data ) {
    console.log(data);
  });
</script>

<style is="custom-style" include="iron-flex">
  paper-spinner {
    margin: 2em;
  }
  .center {
    @apply(--layout-horizontal);
    @apply(--layout-center-justified);
  }
</style>

