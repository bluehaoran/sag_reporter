
<% provide(:title, 'Language Overview: ' + @language.name) %>

<% editable = (logged_in_user.national? or Language.user_limited(logged_in_user).include?(@language)) %>

<%= '<script>console.log("page is editable");</script>'.html_safe if editable %>

<div id="edit-response"></div>
<div id="pending-edits" class="mdl-grid">
  <% @user_pending_edits.each do |edit| %>
    <div class="mdl-cell mdl-cell--4-col">
      <%= render edit %>
    </div>
  <% end %>
</div>

<div class="mdl-grid">
  <div class="mdl-cell mdl-cell--6-col mdl-cell--2-col-phone">
    <h1>Language Overview</h1>
    <%= link_to show_details_language_path(@language) do %>
        <i class="material-icons">pageview</i> More details
    <% end %>
  </div>
  <div class="mdl-cell mdl-cell--4-offset-desktop mdl-cell--2-col">
    <div class="language-name"><h2 id="language-name" class="<%= 'editable' if editable %>"><%= @language.name %><%= render 'shared/edit_icon' if editable %></h2></div>
    <div id="language-iso" class="iso-code <%= 'editable' if editable %>">[<%= @language.iso %>]<%= render 'shared/edit_icon' if editable %></div>
  </div>
</div>

<div class="mdl-grid language-dashboard">

  <!-- general language data -->
  <div class="language-info mdl-cell mdl-cell--4-col">
    <table class="language-data">
      <% if @language.description.present? or editable %>
          <tr><th>Description</th><td id="language-description" class="<%= 'editable' if editable %>"><%= @language.description %><%= render 'shared/edit_icon' if editable %></td></tr>
      <% end %>
      <% if @language.location.present? or editable %>
          <tr><th>Location</th><td id="language-location" class="<%= 'editable' if editable %>"><%= @language.location %><%= render 'shared/edit_icon' if editable %></td></tr>
      <% end %>
      <% if @language.population or editable%>
        <tr id="pop_<%= @language.iso %>">
          <th>Population</th><td id="language-population" class="<%# 'editable' if editable %>"><%= number_with_delimiter(@language.population, :delimiter => ',') %><%# render 'shared/edit_icon' if editable %></td>
        </tr>
        <% if @language.pop_source %>
          <div class="mdl-tooltip" for="pop_<%= @language.iso %>">source: <%= @language.pop_source.name %></div>
        <% end %>
      <% end %>
      <% if @language.family or editable %>
          <tr><th>Family</th><td id="language-family" class="<%= 'editable' if editable %>"><%= @language.family_name if @language.family %><%= render 'shared/edit_icon' if editable %></td></tr>
      <% end %>
      <% if @language.info.present? or editable %>
          <tr><th>Other information</th><td id="language-info" class="<%= 'editable' if editable %>"><%= @language.info %><%= render 'shared/edit_icon' if editable %></td></tr>
      <% end %>
    </table><h4>Translation Status</h4>
    <div class="translation-status mdl-card mdl-shadow--2dp">
      <div class="mdl-card__title" style="background-color: <%= @language.translation_status_colour %>">
        <h2 class="mdl-card__title-text"><%= @language.translation_status.to_s.humanize %></h2>
      </div>
      <div class="mdl-card__supporting-text">
        <p>Translation need/status: <strong id="language-translation-need" class="<%= 'editable' if editable %>"><%= @language.translation_need.humanize %><%= render 'shared/edit_icon' if editable %></strong></p>
        <p>Translation progress: <strong id="language-translation-progress" class="<%= 'editable' if editable %>"><%= @language.translation_progress.humanize %><%= render 'shared/edit_icon' if editable %></strong></p>
      </div>
    </div>
    <table class="language-data">
      <% if editable or (@language.number_of_translations && @language.number_of_translations > 0) %>
          <tr><th>Already existing</th><td><span id="language-number-of-translations" class="<%= 'editable' if editable %>"><%= @language.number_of_translations ? @language.number_of_translations : 0 %><%= render 'shared/edit_icon' if editable %></span> Bible <%= 'version'.pluralize(@language.number_of_translations) %></td></tr>
      <% end %>
      <% if editable or @language.translation_info.present? %>
          <tr><th>Translation info</th><td id="language-translation-info" class="<%= 'editable' if editable %>"><%= @language.translation_info %><%= render 'shared/edit_icon' if editable %></td></tr>
      <% end %>
    </table>

  </div>

  <div class="mdl-cell mdl-cell--4-col">
    <ul class="mdl-list">
      <li class="language-names mdl-list__item">
        <%= link_to 'Alternate Names', show_details_language_path(@language, anchor: 'language-names'), class: 'mdl-list__item-primary-content' %>
        <%= link_to show_details_language_path(@language, anchor: 'language-names'), class: 'mdl-list__item-secondary-content mdl-chip' do %>
            <span class="mdl-chip__text"><%= @language.language_names.count %></span>
        <% end %>
      </li>
      <li class="language-outcome-progress mdl-list__item">
        <%= link_to 'Outcome Progress', show_details_language_path(@language, anchor: 'outcome-progress'), class: 'mdl-list__item-primary-content' %>
      </li>
      <li class="language-bible-translation mdl-list__item">
        <%= link_to 'Bible Translation', show_details_language_path(@language, anchor: 'bible-translation'), class: 'mdl-list__item-primary-content' %>
      </li>
      <li class="language-engaged-organisations mdl-list__item">
        <%= link_to 'Engaged Organisations', show_details_language_path(@language, anchor: 'engaged-organisations'), class: 'mdl-list__item-primary-content' %>
        <%= link_to show_details_language_path(@language, anchor: 'engaged-organisations'), class: 'mdl-list__item-secondary-content mdl-chip' do %>
            <span class="mdl-chip__text"><%= @language.engaged_organisations.count %></span>
        <% end %>
      </li>
      <li class="language-translating-organisations mdl-list__item">
        <%= link_to 'Translating Organisations', show_details_language_path(@language, anchor: 'translating-organisations'), class: 'mdl-list__item-primary-content' %>
        <%= link_to show_details_language_path(@language, anchor: 'translating-organisations'), class: 'mdl-list__item-secondary-content mdl-chip' do %>
            <span class="mdl-chip__text"><%= @language.translating_organisations.count %></span>
        <% end %>
      </li>
      <li class="language-literacy mdl-list__item">
        <%= link_to 'Literacy', show_details_language_path(@language, anchor: 'literacy'), class: 'mdl-list__item-primary-content' %>
      </li>
      <li class="language-mt-resources mdl-list__item">
        <%= link_to 'Mother Tongue Resources', show_details_language_path(@language, anchor: 'mt-resources'), class: 'mdl-list__item-primary-content' %>
        <%= link_to show_details_language_path(@language, anchor: 'mt-resources'), class: 'mdl-list__item-secondary-content mdl-chip' do %>
            <span class="mdl-chip__text"><%= @language.mt_resources.count %></span>
        <% end %>
      </li>
    </ul>
  </div>

  <!-- map -->
  <div class="mdl-cell mdl-cell--4-col">
    <% map = get_map(@language) %>
    <% if map %>
      <%= image_tag(map, alt: "Map for #{@language.name}", class: 'language-map mdl-shadow--2dp') %>
    <% end %>
  </div>

  <div class="mdl-cell mdl-cell--4-col">
    <% if @impact_report %>
      <div class="impact-story mdl-card mdl-shadow--2dp">
        <div class="mdl-card__title">
          <h2 class="mdl-card__title-text">Impact Story</h2>
        </div>
        <div class="mdl-card__supporting-text">
          <div><%= time_ago_in_words(@impact_report.report_date) %> ago</div>
          <%= simple_format @impact_report.content %>
          <% @impact_report.pictures.each do |picture| %>
              <%= image_tag picture.ref_url if picture.ref? %>
          <% end %>
          <%# Show the reporter name if the logged in user is trusted, or if it's them. %>
          <% if @impact_report.reporter and (logged_in_user.trusted? or logged_in_user?(report.reporter)) %>
              <div class="reporter"><%= @impact_report.reporter.name %></div>
          <% end %>
        </div>
        <div class="mdl-card__actions">
          <a class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">
            More impact stories...
          </a>
        </div>
      </div>
    <% else %>
      <p>No impact reports.</p>
    <% end %>
  </div>
</div>

<%= render 'edit_dialogs' if editable %>

<script>
  $('dialog').each(function() {
    let dialog = this;
    if (! dialog.showModal) {
      dialogPolyfill.registerDialog(dialog);
    }
    $(dialog).find('.submit').on('click', function() {
      $(dialog).find('form').submit();
      dialog.close();
    });
    $(dialog).find('.cancel').on('click', function() {
      dialog.close();
    });
  });
  $( document ).ajaxSuccess(function( event, xhr, settings, data ) {
    console.log(data);
  });
</script>

<style is="custom-style" include="iron-flex">
  paper-spinner {
    margin: 2em;
  }
  .center {
    @apply(--layout-horizontal);
    @apply(--layout-center-justified);
  }
</style>

