<% provide(:title, 'Reports grouped by Topic') %>
<h1>Reports grouped by Topic</h1>
<div class="row">
  <div class="col s12 m6 offset-m6">
    <%= render partial: "selector" %>
  </div>
</div>
<div class="row">
  <div class="col s12 m6">
    <%= render partial: "show_archived_switch" %>
  </div>
  <div class="col s12 m6">
    <%= render partial: "date_range" %>
  </div>
</div>
<ul class="collapsible" data-collapsible="accordion">
  <% Topic.all.select{ |t| !t.reports.empty? or !t.impact_reports.empty? }.each do |topic| %>
    <li>
      <div class="collapsible-header <%= colour_class(topic.colour) %>"><%= topic.name %></div>
      <div class="collapsible-body <%= colour_class(topic.colour) %>">
        <p><%= topic.description %></p>
        <% @reports.select{ |r| r.topics.include? topic }.in_groups_of(3, false) do |report_group| %>
          <div class="row">
            <%= render partial: "report", collection: report_group, locals: {time: true, languages: true, topics: false, wrapper: "col s12 m6 l4"} %>
          </div>
        <% end %>
        <% @impact_reports.select{ |r| r.progress_marker and r.progress_marker.topic == topic }.in_groups_of(3, false) do |report_group| %>
          <div class="row">
            <%= render partial: "impact_reports/report", collection: report_group, locals: {time: true, languages: true, topics: false, wrapper: "col s12 m6 l4"} %>
          </div>
        <% end %>
      </div>
    </li>
  <% end %>
  <% unassigned = @reports.select{ |r| r.topics.empty? } %>
  <% unassigned_impact = @impact_reports.select{ |r| !r.progress_marker } %>
  <% unless unassigned.empty? and unassigned_impact.empty? %>
    <li>
      <div class="collapsible-header">No outcome area specified</div>
      <div class="collapsible-body">
        <% unassigned.in_groups_of(3, false) do |report_group| %>
          <div class="row">
            <%= render partial: "report", collection: report_group, locals: {time: true, languages: true, topics: false, wrapper: "col s12 m6 l4"} %>
          </div>
        <% end %>
        <% unassigned_impact.in_groups_of(3, false) do |report_group| %>
          <div class="row">
            <%= render partial: "impact_reports/report", collection: report_group, locals: {time: true, languages: true, topics: false, wrapper: "col s12 m6 l4"} %>
          </div>
        <% end %>
      </div>
    </li>
  <% end %>
</ul>