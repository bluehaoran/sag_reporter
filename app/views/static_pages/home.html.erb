<% provide(:title, "LCI App Home") %>

<% provide(:context_title, 'Welcome!') %>
<% pwd_reset_users = reset_pwd_users %>
<% reg_us_cnt = User.where(:registration_status => 0).count %>
<% zone_approved_cnt = User.where(:registration_status => 1).count %>

<div id="welcome-content">

  <div id="god-at-work-card" class="mdl-card mdl-shadow--2dp">
    <div id="progress-chart-panel">
      <div class="chart-title">Transformation across <span class="language-count"></span> languages</div>
      <div id="national-progress-chart">
        <div class="mdl-spinner mdl-js-spinner is-active"></div>
        <%= link_to "progress chart", national_outcomes_chart_path, remote: true, method: 'GET', id: 'get-national-chart-link' %>
      </div>
    </div>
    <div class="mdl-card__title">
      God is at work
    </div>
    <div class="mdl-card__supporting-text">
      LCI wants to see lives and <strong>communities transformed</strong> in this generation
    </div>
    <div class="mdl-card__actions mdl-card--border">
      <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="report-tasks-trigger">
        <i class="material-icons">create</i>
        Enter and view reports
      </button>
      <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="progress-tasks-trigger">
        <i class="material-icons">show_chart</i>
        Update and assess progress
      </button>
    </div>
  </div>

  <div id="down-to-zero-card" class="mdl-card mdl-shadow--2dp">
    <div id="nt-pie-chart-panel">
      <%
        nt_data = Rails.cache.fetch('NT finish line data', expires_in: 3.days, backup: true) do
          nt_marker = FinishLineMarker.find_by_number 6
          data = build_finish_line_table(Language.all, [nt_marker])[nt_marker]
          data.except(:nothing)
        end
      %>
      <%= pie_chart nt_data.map{ |k, v| [k.to_s.humanize, v]}.to_h,
                    id: 'nt-pie-chart',
                    width: '100px',
                    height: '100px',
                    library: {backgroundColor: "transparent", is3D: true, legend: {position: 'none'}},
                    colors: colours_for_finish_line_data(nt_data) %>
      <div class="chart-title">NT Availability</div>
    </div>
    <div class="mdl-card__title">
      Down to zero
    </div>
    <div class="mdl-card__supporting-text">
      LCI wants to complete the needed <strong>Bible and language products</strong> in this generation
    </div>
    <div class="mdl-card__actions mdl-card--border">
      <%= link_to zones_path, class: 'mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect' do %>
        <i class="material-icons">search</i>
        Zoom in to my area
      <% end %>
      <% link_path = logged_in_user.national? ? nation_path({tab: 'languages', flm: 6}) : zone_path(logged_in_user.zones.first, {tab: 'languages', flm: 6}) %>
      <%= link_to link_path, class: 'mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect' do %>
          <i class="material-icons">collections_bookmark</i>
          Zoom to NT statistics
      <% end %>
      <% link_path = logged_in_user.national? ? nation_path({filter: '1_2_5_6-0123456-0123456-0123456-12', tab: 'languages'}) : zone_path(logged_in_user.zones.first, {filter: '1_2_5_6-0123456-0123456-0123456-12', tab: 'languages'}) %>
      <%= link_to link_path, class: 'mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect' do %>
        <i class="material-icons">watch_later</i>
        Countdown to Zero
      <% end %>
    </div>
  </div>

  <div id="about-card" class="mdl-card mdl-shadow--2dp">
    <div class="mdl-card__title">
      What is LCI?
    </div>
    <div class="mdl-card__actions mdl-card--border">
      <%= link_to about_path, class: 'mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect' do %>
        <i class="material-icons">info</i>
        Find out more about us
      <% end %>
    </div>
  </div>

  <% edit_count = get_edit_count %>
  <% if (logged_in_user.national_curator? && (reg_us_cnt > 0 || edit_count > 0)) || (logged_in_user.lci_board_member? && zone_approved_cnt > 0) %>
  <div id="curator-card" class="mdl-card mdl-shadow--2dp"
     <% if logged_in_user.admin? %>
        style="grid-area: curator;"
    <% end %>>

    <div class="mdl-card__title">
      <% if edit_count > 0 && logged_in_user.national_curator? %>
            Curate Edits
      <% elsif reg_us_cnt > 0 && logged_in_user.national_curator? %>
        Curator Approval
      <% elsif zone_approved_cnt > 0 && logged_in_user.lci_board_member? %>
         LCI Board Member Approval
      <% end %>
    </div>

    <div class="mdl-card__supporting-text">
      <% if edit_count > 0 && logged_in_user.national_curator? %>
        You have <span class="edit-count"><%= edit_count %> <%= 'edit'.pluralize(edit_count) %></span> to curate.
        Please attend to <%= edit_count == 1 ? 'this' : 'these' %> as soon as possible.
      <% elsif reg_us_cnt > 0 && logged_in_user.national_curator? %>
        You have <span class="reg_us_cnt"><%= reg_us_cnt %> <%= 'registration'.pluralize(reg_us_cnt) %></span>
        waiting to your approval.
      <% elsif zone_approved_cnt > 0 && logged_in_user.lci_board_member? %>
          You have <span class="reg_us_cnt"><%= zone_approved_cnt %> <%= 'registration'.pluralize(zone_approved_cnt) %></span>
          waiting to your approval.
      <% end %>
    </div>
    <div class="mdl-card__actions mdl-card--border">
      <% if edit_count > 0  && logged_in_user.national_curator?%>
        <%= link_to curate_edits_path, class: 'mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect' do %>
          <i class="material-icons">done_all</i>
          Curate Edits
        <% end %>
      <% elsif reg_us_cnt > 0  && logged_in_user.national_curator?%>
        <%= link_to user_approval_path, class: 'mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect' do %>
        <i class="material-icons">done_all</i>
          Curator Approval
        <% end %>
      <% elsif zone_approved_cnt > 0 && logged_in_user.lci_board_member? %>
        <%= link_to lciboard_member_approval_path, class: 'mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect' do %>
        <i class="material-icons">done_all</i>
          LCI Board Member Approval
        <% end %>
      <% end %>
    </div>
  </div>
  <% end %>

  <% if logged_in_user.admin? %>
  <div id="admin-card" class="mdl-card mdl-shadow--2dp">
    <div class="mdl-card__title">
      Admin tasks
    </div>
    <div class="mdl-card__actions mdl-card--border">
      <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="admin-tasks-trigger">
        <i class="material-icons">settings</i>
        Admin tasks
      </button>
      <% if pwd_reset_users.any? %>
        <span class="mdl-badge mdl-badge--overlap" data-badge="<%= pwd_reset_users.length %>">
          <button class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect" id="reset-password-trigger">
            <i class="material-icons">vpn_key</i>
            Password reset requests
          </button>
        </span>
      <% end %>
    </div>
  </div>
  <% end %>
</div>

<% grouped_links = @links.select{ |link| link[:condition] }.group_by{ |link| link[:category] } %>
<% grouped_links.each do |category, links| %>
  <dialog class="mdl-dialog" id="<%= category %>-dialog">
    <h4 class="mdl-dialog__title"><%= dialog_titles[category] %></h4>
    <div class="mdl-dialog__content">
      <ul class="mdl-list">
        <% links.each do |link_data| %>
          <li class="mdl-list__item">
            <span class="mdl-list__item-primary-content">
              <%= link_to link_data[:path], class: 'mdl-button mdl-js-button mdl-js-ripple-effect' do %>
                <i class="material-icons"><%= link_data[:icon] %></i>
                <%= link_data[:text] %>
              <% end %>
            </span>
          </li>
        <% end %>
      </ul>
    </div>
    <div class="mdl-dialog__actions">
      <button type="button" class="mdl-button close">Cancel</button>
    </div>
  </dialog>
<% end %>

<dialog class="mdl-dialog" id="resetpassword-dialog">
  <h4 class="mdl-dialog__title">Password Resets</h4>
  <div class="mdl-dialog__content">
    <% if pwd_reset_users.any? %>
      <ul class="mdl-list">
        <% pwd_reset_users.each do |pr_user| %>
          <li id="reset-password-request-<%= pr_user.id %>" class="mdl-list__item">
            <span class="mdl-list__item-primary-content">
              <%= link_to pr_user.name, pr_user %>
            </span>
            <span class="mdl-list__item-secondary-action">
              <%= button_to update_reset_path(id: pr_user.id),
                            id: "pwd-reset-approve-#{pr_user.id}",
                            class: 'mdl-button mdl-js-button mdl-button--icon mdl-button--colored',
                            remote: true,
                            method: :get do %>
                <i class="material-icons">thumb_up</i>
              <% end %>
              <div class="mdl-tooltip mdl-tooltip--right" data-mdl-for="pwd-reset-approve-<%= pr_user.id %>">Approve</div>
              <%= button_to update_reset_path(id: pr_user.id),
                            id: "pwd-reset-reject-#{pr_user.id}",
                            class: 'mdl-button mdl-js-button mdl-button--icon',
                            remote: true,
                            method: :patch do %>
                <i class="material-icons">thumb_down</i>
              <% end %>
              <div class="mdl-tooltip mdl-tooltip--right" data-mdl-for="pwd-reset-reject-<%= pr_user.id %>">Reject</div>
            </span>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>
  <div class="mdl-dialog__actions">
    <button type="button" class="mdl-button close">Close</button>
  </div>
</dialog>