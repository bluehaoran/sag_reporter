<% provide(:title, 'Outcome area transformation') %>

<h1>Transformation by language and outcome area</h1>

<%
  dates = @outcome_scores.keys
  outcome_areas = @outcome_area_colours.keys
%>

<div class="row transformation-dates">
  <div class="col s12 m6 l4">
    Baseline date:
    <%= select_year dates[0].year, start_year: @start_year, end_year: Date.today.year, field_name: 'year_a' %>
    <%= select_month dates[0].month, field_name: 'month_a' %>
  </div>
  <div class="col s12 m6 l4">
    Final date:
    <%= select_year dates[1].year, start_year: @start_year, end_year: Date.today.year, field_name: 'year_b' %>
    <%= select_month dates[1].month, field_name: 'month_b' %>
  </div>
  <div class="col s12 m6 l4 offset-m6">
    <div class="row">
    <%= link_to transformation_path(
                    year_a: dates[0].year,
                    month_a: dates[0].month,
                    year_b: dates[1].year,
                    month_b: dates[1].month
                ), class: 'btn update-transformation-data waves-effect' do %>
      <i class="material-icons">refresh</i>
      Refresh
    <% end %>
    </div>
    <div class="row">
      <%=
        link_to transformation_spreadsheet_path(
                    format: :csv,
                    year_a: dates[0].year,
                    month_a: dates[0].month,
                    year_b: dates[1].year,
                    month_b: dates[1].month
                ), class: 'btn download-transformation-spreadsheet waves-effect' do %>
        <i class="material-icons">file_download</i>
      Get Spreadsheet
      <% end %>
    </div>
  </div>
</div>

<% zone_aggregate = [Hash.new(), Hash.new()] %>

<table>
  <thead>
    <tr>
      <th rowspan="2">Zone</th><th rowspan="2">State</th><th rowspan="2">Language</th>
      <% outcome_areas.each do |outcome_area| %>
        <th colspan="3" class="<%= @outcome_area_colours[outcome_area] %> lighten-3"><%= outcome_area %></th>
      <% end %>
    </tr>
    <tr>
      <% outcome_areas.each do |outcome_area| %>
          <th class="<%= @outcome_area_colours[outcome_area] %> lighten-3"><%= dates[0].strftime('%b %Y') %></th>
          <th class="<%= @outcome_area_colours[outcome_area] %> lighten-3"><%= dates[1].strftime('%b %Y') %></th>
          <th class="<%= @outcome_area_colours[outcome_area] %> lighten-3">Change</th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% @outcome_scores.values.first.each_key do |language| %>
      <tr>
        <td><%= language.zone.name %></td>
        <td><%= language.state_name %></td>
        <td><%= language.language_name %></td>
        <% outcome_areas.each do |outcome_area|
          language_data0 = @outcome_scores[dates[0]][language]
          data0 = language_data0 ? language_data0['content'][outcome_area] : nil
          value0 = data0 ? data0.values.first : 0
          zone_aggregate[0][language.zone.name] ||= Hash.new(0)
          zone_aggregate[0][language.zone.name][outcome_area] += value0
          language_data1 = @outcome_scores[dates[1]][language]
          data1 = language_data1 ? language_data1['content'][outcome_area] : nil
          value1 = data1 ? data1.values.first : 0
          zone_aggregate[1][language.zone.name] ||= Hash.new(0)
          zone_aggregate[1][language.zone.name][outcome_area] += value1
          change = value1 - value0
          change_colour = @outcome_area_colours[outcome_area]
          if change > 0 then change_colour = 'green' end
          if change < 0 then change_colour = 'red' end
          %>
            <td class="<%= @outcome_area_colours[outcome_area] %> lighten-3"><%= value0.round %></td>
            <td class="<%= @outcome_area_colours[outcome_area] %> lighten-3"><%= value1.round %></td>
            <td class="<%= @outcome_area_colours[outcome_area] %> lighten-3 <%= change_colour %>-text text-darken-2"><em><%= change.round %></em></td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<h2>Average of Language Communities by Zone</h2>

<table>
  <thead>
  <tr>
    <th rowspan="2">Zone</th><th rowspan="2">#LCs participating</th>
    <% outcome_areas.each do |outcome_area| %>
        <th colspan="3" class="<%= @outcome_area_colours[outcome_area] %> lighten-3"><%= outcome_area %></th>
    <% end %>
  </tr>
  <tr>
    <% outcome_areas.each do |outcome_area| %>
        <th class="<%= @outcome_area_colours[outcome_area] %> lighten-3"><%= dates[0].strftime('%b %Y') %></th>
        <th class="<%= @outcome_area_colours[outcome_area] %> lighten-3"><%= dates[1].strftime('%b %Y') %></th>
        <th class="<%= @outcome_area_colours[outcome_area] %> lighten-3">Change</th>
    <% end %>
  </tr>
  </thead>
  <tbody>
    <% Zone.find_each do |zone|
    lc_amount = zone.state_languages.in_project.count
    zone_aggregate[0][zone.name] ||= Hash.new(0)
    zone_aggregate[1][zone.name] ||= Hash.new(0)
    %>
    <tr>
      <th><%= zone.name %></th>
      <td><%= lc_amount %></td>
      <% outcome_areas.each do |outcome_area|
        value0 = lc_amount > 0 ? (zone_aggregate[0][zone.name][outcome_area] / lc_amount).round : 0
        value1 = lc_amount > 0 ? (zone_aggregate[1][zone.name][outcome_area] / lc_amount).round : 0 %>
        <td class="<%= @outcome_area_colours[outcome_area] %> lighten-3"><%= value0 %></td>
        <td class="<%= @outcome_area_colours[outcome_area] %> lighten-3"><%= value1 %></td>
          <% change = value1 - value0
          change_colour = @outcome_area_colours[outcome_area]
          if change > 0 then change_colour = 'green' end
          if change < 0 then change_colour = 'red' end %>
        <td class="<%= @outcome_area_colours[outcome_area] %> lighten-3 <%= change_colour %>-text text-darken-2"><em><%= change %></em></td>
      <% end %>
    </tr>
    <% end %>
  </tbody>
</table>